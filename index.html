
<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–¢—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∞ –∫–∞—Ä—Ç–∞</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; font-family: sans-serif; }
    #map { height: 100%; width: 100%; }
    nav {
      position: absolute;
      top: 0; left: 0; bottom: 0;
      background: rgba(255,255,255,0.95);
      z-index: 1000;
      display: flex;
      flex-direction: column;
      padding: 0.5em;
      gap: 0.5em;
    }
    nav button {
      padding: 0.5em 1em;
      background: #007BFF;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-size: 1em;
    }
    #stats {
      position: absolute;
      bottom: 0; left: 0; right: 0;
      background: rgba(255,255,255,0.9);
      padding: 0.5em;
      font-size: 0.9em;
      z-index: 999;
    }
  </style>
</head>
<body>
  <nav>
    <button onclick="startDrawing()">–ú–∞—Ä—à—Ä—É—Ç</button>
    <button onclick="stopDrawing()">–°—Ç–æ–ø</button>
    <button onclick="clearRoute()">–ò–∑—á–∏—Å—Ç–∏</button>
    <button onclick="downloadGPX()">GPX</button>
    <button onclick="centerMap()">üìç GPS</button>
    <button onclick="toggleHuts()">üè† –•–∏–∂–∏</button>
    <button onclick="toggleTheme()">üåò –¢—ä–º–µ–Ω</button>
    <a href="https://checkout.revolut.com/payment-link/30426db7-dff6-4fc3-b70b-63f503215307" target="_blank"><button style="background: green;">üíö –î–∞—Ä–∏</button></a>
  </nav>

  <div id="map"></div>
  <div id="stats">–†–∞–∑—Å—Ç–æ—è–Ω–∏–µ: 0 –∫–º | –í—Ä–µ–º–µ: 0 —á | –°—Ä–µ–¥–Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç: 0 –∫–º/—á</div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/leaflet-rotatedmarker@0.2.0/leaflet.rotatedMarker.js"></script>
  <script>
    const map = L.map('map').setView([42.75, 25.5], 8);
    L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
      maxZoom: 17,
      attribution: '&copy; OpenTopoMap'
    }).addTo(map);

    let route = JSON.parse(localStorage.getItem('route')) || [];
    let drawing = false;
    let routeLine = L.polyline(route, { color: 'red' }).addTo(map);
    let startTime = new Date(localStorage.getItem('startTime')) || new Date();
    if (route.length > 0) updateStats();

    function startDrawing() {
      drawing = true;
      route = [];
      routeLine.setLatLngs([]);
      startTime = new Date();
      localStorage.setItem('startTime', startTime);
    }

    function stopDrawing() { drawing = false; }

    function clearRoute() {
      route = [];
      routeLine.setLatLngs([]);
      localStorage.removeItem('route');
      document.getElementById("stats").textContent = "–†–∞–∑—Å—Ç–æ—è–Ω–∏–µ: 0 –∫–º | –í—Ä–µ–º–µ: 0 —á | –°—Ä–µ–¥–Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç: 0 –∫–º/—á | –ù–∞–¥–º. –≤–∏—Å.: - –º";
    }

    function downloadGPX() {
      const gpx = '<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="TouristMap">\n' +
        route.map(p => `  <trkpt lat="${p.lat}" lon="${p.lng}" />`).join('\n') + '\n</gpx>';
      const blob = new Blob([gpx], { type: 'application/gpx+xml' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'route.gpx';
      a.click();
    }

    function updateStats() {
      let dist = 0;
      for (let i = 1; i < route.length; i++) {
        dist += route[i - 1].distanceTo(route[i]);
      }
      const duration = (new Date() - new Date(startTime)) / 3600000;
      const km = (dist / 1000).toFixed(2);
      const speed = duration > 0 ? (km / duration).toFixed(2) : 0;

      fetch(`https://api.open-elevation.com/api/v1/lookup?locations=${route[route.length-1].lat},${route[route.length-1].lng}`)
        .then(resp => resp.json())
        .then(data => {
          const elev = data.results[0].elevation;
          document.getElementById('stats').innerText =
            `–†–∞–∑—Å—Ç–æ—è–Ω–∏–µ: ${km} –∫–º | –í—Ä–µ–º–µ: ${duration.toFixed(2)} —á | –°—Ä–µ–¥–Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç: ${speed} –∫–º/—á | –ù–∞–¥–º. –≤–∏—Å.: ${elev} –º`;
        })
        .catch(() => {
          document.getElementById('stats').innerText =
            `–†–∞–∑—Å—Ç–æ—è–Ω–∏–µ: ${km} –∫–º | –í—Ä–µ–º–µ: ${duration.toFixed(2)} —á | –°—Ä–µ–¥–Ω–∞ —Å–∫–æ—Ä–æ—Å—Ç: ${speed} –∫–º/—á`;
        });
    }

    let currentPos = null;
    let trackerMarker = null;
    let lastHeading = 0;

    if ('geolocation' in navigator) {
      navigator.geolocation.watchPosition(
        pos => {
          const { latitude, longitude, heading } = pos.coords;
          const point = L.latLng(latitude, longitude);
          currentPos = point;

          if (trackerMarker) {
            if (heading !== null) lastHeading = heading;
            trackerMarker.setLatLng(point);
            trackerMarker.setRotationAngle(lastHeading);
          } else {
            trackerMarker = L.marker(point, {rotationAngle: 0, rotationOrigin: "center"})
              .addTo(map).bindPopup("–í–∏–µ —Å—Ç–µ —Ç—É–∫").openPopup();
          }

          if (drawing) {
            route.push(point);
            routeLine.setLatLngs(route);
            updateStats();
            localStorage.setItem('route', JSON.stringify(route));
          }
        },
        err => console.error('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ GPS:', err),
        { enableHighAccuracy: true, maximumAge: 0, timeout: 10000 }
      );
    }

    function centerMap() {
      if (currentPos) map.setView(currentPos, 14);
    }

    const hutIcon = L.icon({
      iconUrl: 'https://cdn-icons-png.flaticon.com/512/854/854878.png',
      iconSize: [24, 24], iconAnchor: [12, 12]
    });

    const huts = [
      { name: '–•–∏–∂–∞ –†–∞–π', lat: 42.6961, lon: 24.9314 },
      { name: '–•–∏–∂–∞ –ú–∞–ª—å–æ–≤–∏—Ü–∞', lat: 42.185, lon: 23.327 }
    ];

    let hutMarkers = [];
    let hutsVisible = true;
    huts.forEach(h => {
      const marker = L.marker([h.lat, h.lon], { icon: hutIcon }).bindPopup(h.name);
      marker.addTo(map);
      hutMarkers.push(marker);
    });

    function toggleHuts() {
      hutsVisible = !hutsVisible;
      hutMarkers.forEach(m => hutsVisible ? m.addTo(map) : map.removeLayer(m));
    }

    let dark = false;
    function toggleTheme() {
      dark = !dark;
      map.remove();
      document.body.innerHTML = document.body.innerHTML.replace('<div id="map"></div>', '<div id="map"></div>');
      setTimeout(() => location.reload(), 100);
    }
  </script>
</body>
</html>
