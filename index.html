<!DOCTYPE html>
<html lang="bg">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>–¢—É—Ä–∏—Å—Ç–∏—á–µ—Å–∫–∞ –∫–∞—Ä—Ç–∞</title>
  <link rel="manifest" href="manifest.json" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { margin: 0; padding: 0; height: 100%; }
    #map { height: 100%; width: 100%; }
    .menu-toggle {
      position: absolute; top: 1em; right: 1em; z-index: 9999;
      background: white; padding: 0.5em 1em; border-radius: 8px;
      cursor: pointer; box-shadow: 0 0 5px rgba(0,0,0,0.2);
    }
    .dropdown {
      position: absolute; top: 4em; right: 1em; z-index: 9998;
      background: white; padding: 0.5em; border-radius: 10px;
      display: none; flex-direction: column; gap: 0.5em;
      box-shadow: 0 0 10px rgba(0,0,0,0.2);
    }
    .dropdown button {
      background: #f1f1f1; border: none; padding: 0.6em 1em;
      border-radius: 8px; cursor: pointer; text-align: left;
      font-size: 1em;
    }
  </style>
</head>
<body onload="initMap()">
  <div class="menu-toggle" onclick="toggleMenu()">‚ò∞ –ú–µ–Ω—é</div>
  <div class="dropdown" id="menu">
    <button onclick="centerMap()">üìç –¢—Ä–∞–∫–µ—Ä</button>
    <button onclick="clearRoute()">üóë –ò–∑—á–∏—Å—Ç–∏</button>
    <button onclick="downloadGPX()">‚¨áÔ∏è –ï–∫—Å–ø–æ—Ä—Ç GPX</button>
    <button onclick="importGPX()">‚¨ÜÔ∏è –ò–º–ø–æ—Ä—Ç GPX</button>
    <button onclick="alert('–û—Ñ–ª–∞–π–Ω –∑–∞–ø–∏—Å –µ –∞–∫—Ç–∏–≤–µ–Ω.')">üíæ –û—Ñ–ª–∞–π–Ω –∑–∞–ø–∏—Å</button>
    <button onclick="downloadGPX()">üì§ –ï–∫—Å–ø–æ—Ä—Ç –æ—Ñ–ª–∞–π–Ω</button>
    <button onclick="window.open('https://checkout.revolut.com/payment-link/30426db7-dff6-4fc3-b70b-63f503215307', '_blank')">üñ§ –î–∞—Ä–∏</button>
  </div>
  <div id="map"></div>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    let map, currentPos = null, trackerMarker = null, route = [];

    function toggleMenu() {
      const menu = document.getElementById("menu");
      menu.style.display = menu.style.display === "flex" ? "none" : "flex";
    }

    function initMap() {
      map = L.map('map').setView([42.75, 25.5], 8);
      L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png', {
        maxZoom: 17,
        attribution: '&copy; OpenTopoMap'
      }).addTo(map);

      if ('geolocation' in navigator) {
        navigator.geolocation.watchPosition(pos => {
          const { latitude, longitude } = pos.coords;
          currentPos = L.latLng(latitude, longitude);
          if (!trackerMarker) {
            trackerMarker = L.circleMarker(currentPos, {radius:6, color:'blue'}).addTo(map);
          } else {
            trackerMarker.setLatLng(currentPos);
          }
          route.push(currentPos);
          localStorage.setItem('route', JSON.stringify(route));
        }, err => console.error("GPS –≥—Ä–µ—à–∫–∞:", err), {
          enableHighAccuracy: true, timeout: 10000, maximumAge: 0
        });
      }
    }

    function centerMap() {
      if (currentPos) map.setView(currentPos, 15);
    }

    function clearRoute() {
      route = [];
      localStorage.removeItem('route');
      alert("–ú–∞—Ä—à—Ä—É—Ç—ä—Ç –µ –∏–∑—Ç—Ä–∏—Ç");
    }

    function downloadGPX() {
      const gpx = '<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="TouristMap">\n' +
        route.map(p => `<trkpt lat="${p.lat}" lon="${p.lng}" />`).join('\n') + '\n</gpx>';
      const blob = new Blob([gpx], { type: 'application/gpx+xml' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = "track.gpx";
      a.click();
    }

    function importGPX() {
      alert("–ò–º–ø–æ—Ä—Ç –Ω–∞ GPX —Å–∫–æ—Ä–æ —â–µ –±—ä–¥–µ –∞–∫—Ç–∏–≤–∏—Ä–∞–Ω.");
    }
  </script>
</body>
</html>
